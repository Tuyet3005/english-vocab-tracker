<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåºVocab tracker üåº --- Tuy·∫øt</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f8fc;
    }
    .auth-warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px 20px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #ffeaa7;
      display: none;
    }
    .auth-warning.show {
      display: block;
    }
    .auth-warning a {
      color: #0078d4;
      text-decoration: underline;
      cursor: pointer;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .sheet-url-section {
      margin: 20px 0;
      padding: 24px;
      background: linear-gradient(135deg, #fff5f9 0%, #e8f4fd 100%);
      border-radius: 12px;
      border: 2px solid rgba(102, 126, 234, 0.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    .sheet-url-section label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
      letter-spacing: 0.3px;
    }
    .url-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .sheet-url-section input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }
    .sheet-url-section input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .sheet-url-section input.sheet-name-input {
      flex: 0 0 200px;
      min-width: 150px;
    }
    .sheet-url-section button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #cbdffa 0%, #b8d4f1 100%);
      color: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(203, 223, 250, 0.3);
      position: relative;
      overflow: hidden;
    }
    .sheet-url-section button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transition: left 0.5s;
    }
    .sheet-url-section button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(203, 223, 250, 0.4);
    }
    .sheet-url-section button:hover::before {
      left: 100%;
    }
    .sheet-url-section .btn-refresh {
      background: linear-gradient(135deg, #ff77b1 0%, #ff5a95 100%);
      box-shadow: 0 4px 15px rgba(255, 119, 177, 0.3);
    }
    .sheet-url-section .btn-refresh:hover {
      box-shadow: 0 6px 25px rgba(255, 119, 177, 0.4);
    }
    .data-section {
      margin-top: 25px;
    }
    .data-section h2 {
      color: #555;
    }
    .stats-summary {
      background: linear-gradient(135deg, #fff5f9 0%, #f5f8fc 100%);
      border: none;
      border-radius: 16px;
      padding: 8px 10px;
      margin-bottom: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
      gap: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    .stat-item {
      text-align: center;
      padding: 5px 3px;
      background: white;
      border-radius: 12px;
      border: none;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .stat-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .stat-item .stat-label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    .stat-item .stat-count {
      font-size: 32px;
      font-weight: 700;
      color: #2e7d32;
    }
    .stat-item.new {
      background: linear-gradient(135deg, #ff77b1 0%, #ff5a95 100%);
      color: white;
    }
    .stat-item.new .stat-label {
      color: rgba(255, 255, 255, 0.9);
    }
    .stat-item.new .stat-count {
      color: white;
    }
    .stat-item.forgotten {
      background: linear-gradient(135deg, #ffbf00 0%, #ffa500 100%);
      color: white;
    }
    .stat-item.forgotten .stat-label {
      color: rgba(255, 255, 255, 0.9);
    }
    .stat-item.forgotten .stat-count {
      color: white;
    }
    .stat-item.learned {
      background: linear-gradient(135deg, #cbdffa 0%, #a8d5ff 100%);
      color: #1a5490;
    }
    .stat-item.learned .stat-label {
      color: #1a5490;
    }
    .stat-item.learned .stat-count {
      color: #1a5490;
    }
    .stat-item.known {
      background: linear-gradient(135deg, #e9ffe9 0%, #d4f5d4 100%);
      color: #2e7d32;
    }
    .stat-item.known .stat-label {
      color: #2e7d32;
    }
    .stat-item.known .stat-count {
      color: #2e7d32;
    }
    .cache-info {
      font-size: 12px;
      color: #666;
      padding: 10px 14px;
      background: linear-gradient(135deg, #e9ffe9 0%, #f5f8fc 100%);
      border-radius: 8px;
      display: inline-block;
      white-space: nowrap;
      border: 1px solid rgba(46, 125, 50, 0.1);
    }
    .cache-info.fresh {
      background: linear-gradient(135deg, #fff5f9 0%, #ffefe7 100%);
      border: 1px solid rgba(255, 119, 177, 0.1);
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .error {
      color: #d13438;
      padding: 10px;
      background: #fef0f0;
      border-radius: 4px;
      margin: 10px 0;
    }
    .worksheet {
      margin: 20px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .worksheet-header {
      background: #0078d4;
      color: white;
      padding: 10px 15px;
      font-weight: bold;
    }
    .worksheet-info {
      background: #f0f0f0;
      padding: 8px 15px;
      font-size: 12px;
      color: #666;
    }
    .table-container {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
      margin-bottom: 30px;
      padding: 20px;
      background: #fff9f7;
      border: 1px solid rgba(255, 119, 177, 0.1);
      border-radius: 12px;
    }
    .tabs-container {
      margin-top: 25px;
      display: flex;
      gap: 12px;
      background: linear-gradient(90deg, rgba(240, 248, 255, 0.5) 0%, rgba(255, 255, 255, 0.5) 100%);
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .tab-button {
      padding: 12px 28px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      border-radius: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }
    .tab-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
      transition: left 0.5s;
    }
    .tab-button:hover {
      border-color: #c0c0c0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    .tab-button:hover::before {
      left: 100%;
    }
    .tab-button.active {
      background: linear-gradient(135deg, #f5c2ef 0%, #f0a8e8 100%);
      color: #333;
      border-color: transparent;
      box-shadow: 0 6px 20px rgba(245, 194, 239, 0.4);
    }
    .tab-content {
      display: none;
      padding-top: 25px;
      animation: fadeIn 0.4s ease;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
    }
    th {
      background: linear-gradient(135deg, #f3c2ef 0%, #edb4e8 100%);
      color: #333;
      padding: 14px 12px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
      border: none;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    th:first-child {
      border-radius: 8px 0 0 0;
    }
    th:last-child {
      border-radius: 0 8px 0 0;
    }
    td {
      padding: 12px;
      border: none;
      background: white;
      transition: all 0.2s ease;
    }
    tr {
      transition: all 0.2s ease;
    }
    tr:hover td {
      background: rgba(243, 194, 239, 0.08);
    }
    tbody tr:hover {
      background-color: rgba(243, 194, 239, 0.05);
    }
    tr:nth-child(even) td {
      background: rgba(243, 194, 239, 0.02);
    }
    tr:nth-child(even):hover td {
      background: rgba(243, 194, 239, 0.08);
    }
    tr:hover td {
      background: rgba(243, 194, 239, 0.08);
    }
    .file-info {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .file-info h3 {
      margin: 0 0 10px 0;
      color: #0078d4;
    }
    .file-info p {
      margin: 5px 0;
      color: #666;
    }
    .topic-filter-buttons {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .topic-filter-buttons button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #f93b1d 0%, #ea1e63 100%);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(249, 59, 29, 0.3);
      position: relative;
      overflow: hidden;
    }
    .topic-filter-buttons button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .topic-filter-buttons button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(249, 59, 29, 0.4);
    }
    .topic-filter-buttons button:hover::before {
      width: 300px;
      height: 300px;
    }
    .topic-filter-buttons button[style*="background: #666"] {
      background: linear-gradient(135deg, #757575 0%, #424242 100%) !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .topic-filter-buttons button[style*="background: #666"]:hover {
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
    }
    .filter-status {
      color: #f93b1d;
      font-weight: 600;
      font-size: 14px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .newest-topics-container {
      margin-top: 20px;
    }
    .topic-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .topic-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    .topic-title {
      margin: 0;
      font-size: 18px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .topic-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    .topic-name {
      flex: 1;
      font-weight: 600;
    }
    .topic-word-count {
      color: #666;
      font-size: 14px;
      font-weight: normal;
      background: #fff;
      padding: 4px 12px;
      border-radius: 15px;
      border: 1px solid #ddd;
    }
    .topic-content {
      padding: 20px;
      background: white;
    }
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    /* Word Cards Styles */
    .word-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      padding: 15px;
      background: #f8fcff;
      border-radius: 16px;
      margin: 0;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 768px) {
      .word-cards-container {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 10px;
        margin: 0;
        border-radius: 12px;
      }
    }
    @media (max-width: 480px) {
      .word-cards-container {
        padding: 8px;
        gap: 10px;
        margin: 0;
        border-radius: 8px;
      }
    }
    .word-card {
      background: linear-gradient(145deg, #ffffff 0%, #f9fdff 100%);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
    }
    .card-number {
      position: absolute;
      top: 8px;
      left: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      min-width: 20px;
      text-align: center;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .word-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      border-color: rgba(255, 119, 177, 0.3);
    }
    .word-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff77b1, #667eea, #764ba2);
      border-radius: 16px 16px 0 0;
    }
    .word-card.flag-new::before {
      background: linear-gradient(90deg, #ff77b1, #ff5a95);
    }
    .word-card.flag-known::before {
      background: linear-gradient(90deg, #4ade80, #22c55e);
    }
    .word-card.flag-learned::before {
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
    }
    .word-card.flag-forgotten::before {
      background: linear-gradient(90deg, #f97316, #ea580c);
    }
    .word-main {
      margin-bottom: 15px;
    }
    .word-english {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
      line-height: 1.2;
    }
    .word-pronunciation {
      font-size: 16px;
      color: #667eea;
      font-family: 'Courier New', monospace;
      margin-bottom: 12px;
      font-weight: 500;
    }
    .word-pos {
      display: inline-block;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      color: #4338ca;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
    }
    .word-meaning {
      font-size: 15px;
      color: #475569;
      margin-bottom: 15px;
      line-height: 1.5;
      font-weight: 500;
    }
    .word-synonyms {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 12px;
    }
    .synonyms-label {
      font-size: 12px;
      font-weight: 600;
      color: #16a34a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .synonyms-text {
      font-size: 14px;
      color: #22c55e;
      font-weight: 500;
      line-height: 1.4;
    }
    .word-example {
      font-style: italic;
      font-size: 14px;
      color: #64748b;
      padding: 10px 0;
      border-top: 1px solid #e2e8f0;
      margin-top: 12px;
    }
    .card-flag {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .card-flag.new {
      background: linear-gradient(135deg, #ff77b1, #ff5a95);
    }
    .card-flag.known {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }
    .card-flag.learned {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    .card-flag.forgotten {
      background: linear-gradient(135deg, #f97316, #ea580c);
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="authWarning" class="auth-warning">
      ‚ö†Ô∏è Authentication expired or not completed. <a onclick="window.location.href='/auth.html'">Click here to authenticate</a>. You can still view cached data below.
    </div>
    
    <h1>üåºVocab tracker üåº --- Tuy·∫øt</h1>

    <div class="sheet-url-section">
      <label for="sheetUrl">Excel Sheet URL:</label>
      <div class="url-input-group">
        <input type="text" id="sheetUrl" placeholder="Enter SharePoint/OneDrive sharing link">
        <input type="text" id="sheetName" class="sheet-name-input" placeholder="Sheet name (optional)">
        <button onclick="updateSheetUrl()">Update URL</button>
        <button class="btn-refresh" onclick="refreshSheetData()">üîÑ Refresh Data</button>
        <div id="cacheInfo" style="margin-left: auto;"></div>
      </div>
    </div>

    <div class="data-section">
      <div id="statsSummary" class="stats-summary">
        <div class="stat-item new">
          <div class="stat-label">üÜï New</div>
          <div class="stat-count" id="statNew">0</div>
        </div>
        <div class="stat-item forgotten">
          <div class="stat-label">‚ùì Forgotten</div>
          <div class="stat-count" id="statForgotten">0</div>
        </div>
        <div class="stat-item learned">
          <div class="stat-label">üëç Learned</div>
          <div class="stat-count" id="statLearned">0</div>
        </div>
        <div class="stat-item known">
          <div class="stat-label">‚úÖ Known</div>
          <div class="stat-count" id="statKnown">0</div>
        </div>
        <div class="stat-item total" style="background: linear-gradient(135deg, #f3c2ef 0%, #eda8e8 100%); color: #333;">
          <div class="stat-label" style="color: #333;">üìä Total Words</div>
          <div class="stat-count" id="statTotal" style="color: #d946a6; font-size: 36px;">0</div>
        </div>
        <div class="stat-item topics" style="background: linear-gradient(135deg, #c7bcf6 0%, #b0a5ed 100%); color: #333;">
          <div class="stat-label" style="color: #333;">üìö Topics</div>
          <div class="stat-count" id="statTopics" style="color: #6d4fa8; font-size: 36px;">0</div>
        </div>
      </div>
      <div class="tabs-container">
        <button class="tab-button active" onclick="switchTab('filterMode')">üîç Filter mode</button>
        <button class="tab-button" onclick="switchTab('allVocabMode')">üìö All vocab mode</button>
      </div>
      <div id="filterMode" class="tab-content active">
        <div class="topic-filter-buttons">
          <button onclick="filterByNewestTopic()">üìç Newest Topic</button>
          <button onclick="filterBy5NewestTopics()">üìö 5 Newest Topics</button>
          <button onclick="filter30NewestWords()">‚≠ê 30 Newest Words</button>
          <button onclick="filterRandomNewWords()">üé≤ 10 Random New Words</button>
          <button onclick="startGameMode()">üéÆ Play Game</button>
          <button onclick="clearFilter()" id="clearFilterBtn" style="display: none; background: #666;">Clear Filter</button>
          <span id="filterStatus"></span>
        </div>
        <div id="dataContainerFilterMode">
          <div style="padding: 20px; color: #666; text-align: center;">Click "üìç Newest Topic", "üìö 5 Newest Topics", "‚≠ê 30 Newest Words", "üé≤ 10 Random New Words" or "üéÆ Play Game" button above to filter vocabulary</div>
        </div>
      </div>
      <div id="allVocabMode" class="tab-content">
        <div class="topic-filter-buttons">
          <button onclick="toggleAllVocabSortOrder()" id="sortOrderBtn">üìä Newest ‚Üí Oldest</button>
        </div>
        <div id="dataContainerAllVocab"></div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching functionality
    function switchTab(tabName) {
      // Hide all tabs
      document.getElementById('filterMode').classList.remove('active');
      document.getElementById('allVocabMode').classList.remove('active');
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Re-render data in the active tab
      if(currentData) {
        if(tabName === 'filterMode') {
          if(isFiltered) {
            // Re-render filtered view
            const worksheet = currentData.worksheets[0];
            const newestTopic = worksheet.topics[worksheet.topics.length - 1];
            const topicCount = newestTopic.words.length;
            const filteredData = {
              ...currentData,
              worksheets: [{
                ...worksheet,
                topics: [newestTopic],
                statistics: {
                  totalTopics: 1,
                  totalWords: topicCount,
                  byFlag: calculateTopicStats([newestTopic])
                }
              }]
            };
            document.getElementById('dataContainerFilterMode').innerHTML = renderSheetData(filteredData);
          } else {
            // Show empty state message in filter mode
            document.getElementById('dataContainerFilterMode').innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Click "üìç Newest Topic" button above to filter vocabulary</div>';
          }
        } else {
          document.getElementById('dataContainerAllVocab').innerHTML = renderSheetData(currentData, allVocabReverseOrder, false);
        }
      }
    }

    // Store the full data globally for filtering
    let currentData = null;
    let isFiltered = false;
    let gameMode = false;
    let gameWords = [];
    let currentWordIndex = 0;
    let allVocabReverseOrder = false;

    // Start game mode - show one flashcard at a time with navigation
    function startGameMode() {
      if (!currentData || !currentData.worksheets || currentData.worksheets.length === 0) {
        alert('No data to play with');
        return;
      }

      // Collect all words with 'n' or '?' flag from all worksheets and topics
      gameWords = [];
      currentData.worksheets.forEach(worksheet => {
        if (worksheet.topics && worksheet.topics.length > 0) {
          worksheet.topics.forEach(topic => {
            if (topic.words && topic.words.length > 0) {
              topic.words.forEach(word => {
                const flagValue = word.flag ? word.flag.toString().toLowerCase().trim() : '';
                if (flagValue === 'n' || flagValue === '?') {
                  gameWords.push({
                    ...word,
                    topicName: topic.name,
                    worksheetName: worksheet.name
                  });
                }
              });
            }
          });
        }
      });

      if (gameWords.length === 0) {
        alert('No words with "n" or "?" flags found for the game');
        return;
      }

      // Shuffle words for random order
      gameWords = gameWords.sort(() => 0.5 - Math.random());
      currentWordIndex = 0;
      gameMode = true;

      // Show first word
      showGameWord();

      // Update filter status
      isFiltered = true;
      document.getElementById('filterStatus').innerHTML = `Game Mode: <strong>${gameWords.length} words</strong> to practice`;
      document.getElementById('filterStatus').className = 'filter-status';
      document.getElementById('clearFilterBtn').style.display = 'inline-block';
    }

    function showGameWord() {
      if (!gameMode || gameWords.length === 0) return;

      const word = gameWords[currentWordIndex];
      const container = document.getElementById('dataContainerFilterMode');
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 600px; margin: 0 auto;">
          <div style="display: flex; justify-content: center; align-items: center; margin-top: 30px; gap: 40px;">
            <button onclick="previousGameWord()" 
                    style="background: #acd6ff; color: #1a5490; border: none; padding: 12px 24px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; ${currentWordIndex === 0 ? 'opacity: 0.4; cursor: not-allowed;' : ''}"
                    ${currentWordIndex === 0 ? 'disabled' : ''}>
              ‚¨ÖÔ∏è Previous Word
            </button>
            <span style="font-weight: bold; background: #f3f4f6; color: #374151; padding: 8px 16px; border-radius: 8px; font-size: 14px;">
              Word ${currentWordIndex + 1} of ${gameWords.length}
            </span>
            <button onclick="nextGameWord()" 
                    style="background: #e1fcea; color: #2a511d; border: none; padding: 12px 24px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; ${currentWordIndex === gameWords.length - 1 ? 'opacity: 0.4; cursor: not-allowed;' : ''}"
                    ${currentWordIndex === gameWords.length - 1 ? 'disabled' : ''}>
              Next Word ‚û°Ô∏è
            </button>
          </div>
          
          <div style="width: 100%; display: flex; justify-content: center; margin: 20px 0;">
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 500px; width: 100%;">
              <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
                <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 18px;">${word.topicName || 'Topic'}</h3>
                <span style="color: #6b7280; font-size: 14px;">${word.worksheetName || 'Worksheet'}</span>
                ${word.flag ? `<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">${word.flag}</span>` : ''}
              </div>
              <div style="text-align: center; margin-bottom: 16px;">
                <div style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 8px;">
                  ${word.english || 'N/A'}
                </div>
                <div style="font-size: 20px; color: #4b5563;">
                  ${word.vietnamese || 'N/A'}
                </div>
              </div>
              ${word.example ? `<div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #3b82f6;"><strong style="color: #1f2937;">Example:</strong> <span style="color: #4b5563;">${word.example}</span></div>` : ''}
              ${word.note ? `<div style="background: #fef7ff; padding: 12px; border-radius: 8px; border-left: 4px solid #a855f7;"><strong style="color: #1f2937;">Note:</strong> <span style="color: #4b5563;">${word.note}</span></div>` : ''}
            </div>
          </div>
        </div>
      `;
      
      // Remove container styling to show cards directly
      container.style.padding = '0';
      container.style.margin = '0';
      container.style.background = 'transparent';
      container.style.border = 'none';
      container.style.boxShadow = 'none';
    }

    function previousGameWord() {
      if (!gameMode || currentWordIndex <= 0) return;
      currentWordIndex--;
      showGameWord();
    }

    function nextGameWord() {
      if (!gameMode || currentWordIndex >= gameWords.length - 1) return;
      currentWordIndex++;
      showGameWord();
    }

    // Filter to show 30 newest words (by order in data)
    function filter30NewestWords() {
      if (!currentData || !currentData.worksheets || currentData.worksheets.length === 0) {
        alert('No data to filter');
        return;
      }

      // Collect all words from all worksheets and topics in order
      let allWords = [];
      currentData.worksheets.forEach(worksheet => {
        if (worksheet.topics && worksheet.topics.length > 0) {
          worksheet.topics.forEach(topic => {
            if (topic.words && topic.words.length > 0) {
              topic.words.forEach((word, wordIndex) => {
                allWords.push({
                  ...word,
                  topicName: topic.name,
                  worksheetName: worksheet.name,
                  originalIndex: wordIndex
                });
              });
            }
          });
        }
      });

      if (allWords.length === 0) {
        alert('No words found in the data');
        return;
      }

      // Get the last 30 words (newest by order)
      const wordCount = Math.min(30, allWords.length);
      const newestWords = allWords.slice(-wordCount);

      // Create a mock topic structure for rendering
      const newestWordsTopic = {
        name: `${wordCount} Newest Words`,
        words: newestWords
      };

      // Create filtered data structure
      const filteredData = {
        worksheets: [{
          name: 'Newest Words Selection',
          topics: [newestWordsTopic]
        }]
      };

      // Render filtered view with cards directly
      const container = document.getElementById('dataContainerFilterMode');
      container.innerHTML = renderSheetDataAsCards(filteredData);
      // Remove container styling to show cards directly
      container.style.padding = '0';
      container.style.margin = '0';
      container.style.background = 'transparent';
      container.style.border = 'none';
      container.style.boxShadow = 'none';

      // Update filter status
      isFiltered = true;
      document.getElementById('filterStatus').innerHTML = `Found <strong>${wordCount} newest words</strong> from all topics`;
      document.getElementById('filterStatus').className = 'filter-status';
      document.getElementById('clearFilterBtn').style.display = 'inline-block';
    }

    // Filter to show 10 random words with 'n' flag
    function filterRandomNewWords() {
      if (!currentData || !currentData.worksheets || currentData.worksheets.length === 0) {
        alert('No data to filter');
        return;
      }

      // Collect all words with 'n' flag from all worksheets and topics
      let allNewWords = [];
      currentData.worksheets.forEach(worksheet => {
        if (worksheet.topics && worksheet.topics.length > 0) {
          worksheet.topics.forEach(topic => {
            if (topic.words && topic.words.length > 0) {
              topic.words.forEach(word => {
                const flagValue = word.flag ? word.flag.toString().toLowerCase().trim() : '';
                if (flagValue === 'n' || flagValue === '?') {
                  allNewWords.push({
                    ...word,
                    topicName: topic.name,
                    worksheetName: worksheet.name
                  });
                }
              });
            }
          });
        }
      });

      if (allNewWords.length === 0) {
        alert('No new words (flag "n") found in the data');
        return;
      }

      // Shuffle and select up to 10 random words
      const shuffled = allNewWords.sort(() => 0.5 - Math.random());
      const selectedWords = shuffled.slice(0, Math.min(10, allNewWords.length));

      // Create a mock topic structure for rendering
      const randomTopic = {
        name: `Random ${selectedWords.length} New Words`,
        words: selectedWords
      };

      // Create filtered data structure
      const filteredData = {
        worksheets: [{
          name: 'Random Selection',
          topics: [randomTopic]
        }]
      };

      // Render filtered view with cards directly
      const container = document.getElementById('dataContainerFilterMode');
      container.innerHTML = renderSheetDataAsCards(filteredData);
      // Remove container styling to show cards directly
      container.style.padding = '0';
      container.style.margin = '0';
      container.style.background = 'transparent';
      container.style.border = 'none';
      container.style.boxShadow = 'none';

      // Update filter status
      isFiltered = true;
      document.getElementById('filterStatus').innerHTML = `Found <strong>${selectedWords.length} random new words</strong>`;
      document.getElementById('filterStatus').className = 'filter-status';
      document.getElementById('clearFilterBtn').style.display = 'inline-block';
    }

    // Filter to show only the newest topic
    function filterByNewestTopic() {
      if (!currentData || !currentData.worksheets || currentData.worksheets.length === 0) {
        alert('No data to filter');
        return;
      }

      // Get the first worksheet (usually the main one)
      const worksheet = currentData.worksheets[0];
      if (!worksheet.topics || worksheet.topics.length === 0) {
        alert('No topics found');
        return;
      }

      // Get the last topic (newest)
      const newestTopic = worksheet.topics[worksheet.topics.length - 1];
      const topicName = newestTopic.name;
      const topicCount = newestTopic.words.length;

      // Create filtered data with only the newest topic
      const filteredData = {
        ...currentData,
        worksheets: [{
          ...worksheet,
          topics: [newestTopic],
          statistics: {
            totalTopics: 1,
            totalWords: topicCount,
            byFlag: calculateTopicStats([newestTopic])
          }
        }]
      };

      // Render filtered view with cards directly
      const container = document.getElementById('dataContainerFilterMode');
      container.innerHTML = renderSheetDataAsCards(filteredData);
      // Remove container styling to show cards directly
      container.style.padding = '0';
      container.style.margin = '0';
      container.style.background = 'transparent';
      container.style.border = 'none';
      container.style.boxShadow = 'none';

      // Update filter status
      isFiltered = true;
      document.getElementById('filterStatus').innerHTML = `Found topic: <strong>${escapeHtml(topicName)}</strong> (${topicCount} words)`;
      document.getElementById('filterStatus').className = 'filter-status';
      document.getElementById('clearFilterBtn').style.display = 'inline-block';
    }

    // Filter to show the 5 newest topics
    function filterBy5NewestTopics() {
      if (!currentData || !currentData.worksheets || currentData.worksheets.length === 0) {
        alert('No data to filter');
        return;
      }

      // Get the first worksheet (usually the main one)
      const worksheet = currentData.worksheets[0];
      if (!worksheet.topics || worksheet.topics.length === 0) {
        alert('No topics found');
        return;
      }

      // Get the last 5 topics (or all if less than 5)
      const topicCount = Math.min(5, worksheet.topics.length);
      let newestTopics = worksheet.topics.slice(-topicCount);
      
      // Sort topics by name for better organization
      newestTopics = newestTopics.sort((a, b) => {
        return a.name.localeCompare(b.name, 'vi', { numeric: true, sensitivity: 'base' });
      });
      
      const totalWords = newestTopics.reduce((sum, topic) => sum + (topic.words ? topic.words.length : 0), 0);

      // Render filtered view with organized topics
      const container = document.getElementById('dataContainerFilterMode');
      container.innerHTML = render5NewestTopicsWithHeaders(newestTopics);
      // Remove container styling to show cards directly
      container.style.padding = '0';
      container.style.margin = '0';
      container.style.background = 'transparent';
      container.style.border = 'none';
      container.style.boxShadow = 'none';

      // Update filter status
      isFiltered = true;
      const topicNames = newestTopics.map(topic => topic.name).join(', ');
      document.getElementById('filterStatus').innerHTML = `Found <strong>${topicCount} newest topics</strong> (${totalWords} words): ${escapeHtml(topicNames)}`;
      document.getElementById('filterStatus').className = 'filter-status';
      document.getElementById('clearFilterBtn').style.display = 'inline-block';
    }

    // Render 5 newest topics with clear headers and organized layout
    function render5NewestTopicsWithHeaders(topics) {
      let html = '<div class="newest-topics-container">';
      
      topics.forEach((topic, index) => {
        const wordCount = topic.words ? topic.words.length : 0;
        
        html += `
          <div class="topic-section">
            <div class="topic-header">
              <h3 class="topic-title">
                <span class="topic-number">${index + 1}.</span>
                <span class="topic-name">${escapeHtml(topic.name)}</span>
                <span class="topic-word-count">(${wordCount} words)</span>
              </h3>
            </div>
            <div class="topic-content">
              ${renderTopicAsCards(topic)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      return html;
    }

    // Clear filter and show all data
    function clearFilter() {
      if (!currentData) {
        alert('No data available');
        return;
      }

      // Re-render empty state in filter mode
      const container = document.getElementById('dataContainerFilterMode');
      container.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Click "üìç Newest Topic", "üìö 5 Newest Topics", "‚≠ê 30 Newest Words", "üé≤ 10 Random New Words" or "üéÆ Play Game" button above to filter vocabulary</div>';
      // Reset container styling
      container.style.padding = '';
      container.style.margin = '';
      container.style.background = '';
      container.style.border = '';
      container.style.boxShadow = '';

      // Update filter status
      isFiltered = false;
      gameMode = false;
      gameWords = [];
      currentWordIndex = 0;
      document.getElementById('filterStatus').innerHTML = '';
      document.getElementById('filterStatus').className = '';
      document.getElementById('clearFilterBtn').style.display = 'none';
    }

    // Calculate statistics for a single topic or array of topics
    function calculateTopicStats(topics) {
      const stats = {
        new: 0,
        known: 0,
        forgotten: 0,
        learned: 0
      };

      topics.forEach(topic => {
        if (topic.words) {
          topic.words.forEach(word => {
            const flag = (word.flag || '').toString().toLowerCase().trim();
            if (flag === 'n') stats.new++;
            else if (flag === 'y') stats.known++;
            else if (flag === '?') stats.forgotten++;
            else if (flag === 'ok') stats.learned++;
          });
        }
      });

      return stats;
    }

    // Toggle sort order in All vocab mode (newest ‚Üí oldest or oldest ‚Üí newest)
    function toggleAllVocabSortOrder() {
      allVocabReverseOrder = !allVocabReverseOrder;
      
      // Update button text
      const btn = document.getElementById('sortOrderBtn');
      if (allVocabReverseOrder) {
        btn.textContent = 'üìä Oldest ‚Üí Newest';
      } else {
        btn.textContent = 'üìä Newest ‚Üí Oldest';
      }
      
      // Re-render All vocab mode with the new sort order
      if (currentData) {
        document.getElementById('dataContainerAllVocab').innerHTML = renderSheetData(currentData, allVocabReverseOrder, false);
      }
    }

    // Check authentication status (returns boolean)
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        return data.authenticated;
      } catch (err) {
        console.error('Auth check failed:', err);
        return false;
      }
    }

    // Show authentication warning
    function showAuthWarning() {
      document.getElementById('authWarning').classList.add('show');
    }

    // Hide authentication warning
    function hideAuthWarning() {
      document.getElementById('authWarning').classList.remove('show');
    }

    // Load current sheet URL and name
    async function loadSheetUrl() {
      try {
        const response = await fetch('/api/sheet/url');
        const data = await response.json();
        document.getElementById('sheetUrl').value = data.sheetUrl;
        document.getElementById('sheetName').value = data.sheetName || '';
      } catch (err) {
        console.error('Failed to load sheet URL:', err);
      }
    }

    // Update sheet URL and name
    async function updateSheetUrl() {
      const sheetUrl = document.getElementById('sheetUrl').value;
      const sheetName = document.getElementById('sheetName').value;

      if (!sheetUrl) {
        alert('Please enter a sheet URL');
        return;
      }

      try {
        const response = await fetch('/api/sheet/url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sheetUrl, sheetName })
        });

        const data = await response.json();

        if (data.success) {
          alert('Sheet URL updated successfully');
          // Load cached data from the new URL (no refresh unless user explicitly clicks refresh)
          loadSheetData(false);
        } else {
          alert('Failed to update sheet URL');
        }
      } catch (err) {
        console.error('Failed to update sheet URL:', err);
        alert('Error updating sheet URL');
      }
    }

    // Load sheet data
    async function loadSheetData(forceRefresh = false) {
      const containerFilter = document.getElementById('dataContainerFilterMode');
      const containerAll = document.getElementById('dataContainerAllVocab');
      const cacheInfoDiv = document.getElementById('cacheInfo');
      const sheetName = document.getElementById('sheetName').value;
      
      // Only show loading if forcing refresh (never on page load)
      if (forceRefresh) {
        containerFilter.innerHTML = '<div class="loading">Refreshing data...</div>';
        containerAll.innerHTML = '<div class="loading">Refreshing data...</div>';
        cacheInfoDiv.innerHTML = '';
      }
      
      try {
        let url = '/api/sheet/data';
        const params = new URLSearchParams();
        if (forceRefresh) params.append('refresh', 'true');
        if (sheetName) params.append('sheetName', sheetName);
        if (params.toString()) url += '?' + params.toString();
        
        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
          // Only show errors if refreshing or if we have no current data
          if (forceRefresh || !currentData) {
            if (response.status === 401) {
              const errorMsg = `<div class="error">${data.error} <a href="/auth.html">Authenticate now</a></div>`;
              containerFilter.innerHTML = errorMsg;
              containerAll.innerHTML = errorMsg;
              showAuthWarning();
            } else {
              const errorMsg = `<div class="error">Error: ${data.error}</div>`;
              containerFilter.innerHTML = errorMsg;
              containerAll.innerHTML = errorMsg;
            }
            clearStats();
            cacheInfoDiv.innerHTML = '';
          }
        } else {
          // Always hide auth warning if we got data
          hideAuthWarning();
          
          // Update cache info (only if refreshing or no data was displayed yet)
          if (forceRefresh || !currentData) {
            if (data._message) {
              cacheInfoDiv.innerHTML = `<div class="cache-info">${escapeHtml(data._message)}</div>`;
            } else if (data._cached) {
              const cachedTime = new Date(data._cachedAt).toLocaleString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit', 
                second: '2-digit',
                day: 'numeric',
                month: 'numeric',
                year: 'numeric'
              });
              cacheInfoDiv.innerHTML = `<div class="cache-info">üì¶ Cached: ${cachedTime}</div>`;
            } else if (data._fetchedAt) {
              const fetchedTime = new Date(data._fetchedAt).toLocaleString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                day: 'numeric',
                month: 'numeric',
                year: 'numeric'
              });
              cacheInfoDiv.innerHTML = `<div class="cache-info fresh">‚ú® Fresh: ${fetchedTime}</div>`;
            }
          }

          // Always display statistics and data when available
          const totalStats = calculateTotalStats(data);
          displayStats(totalStats);

          // Store the data globally for filtering
          currentData = data;
          
          // Reset sort order when loading new data (only if forcing refresh)
          if (forceRefresh) {
            allVocabReverseOrder = false;
            const sortBtn = document.getElementById('sortOrderBtn');
            if (sortBtn) {
              sortBtn.textContent = 'üìä Newest ‚Üí Oldest';
            }
          }
          
          // Render data
          if (forceRefresh) {
            containerFilter.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Click "üìç Newest Topic" button above to filter vocabulary</div>';
          }
          containerAll.innerHTML = renderSheetData(data, allVocabReverseOrder, false);
        }
      } catch (err) {
        console.error('Failed to load sheet data:', err);
        // Only show error message if refreshing or no current data
        if (forceRefresh || !currentData) {
          const errorMsg = `<div class="error">Error: ${err.message}</div>`;
          containerFilter.innerHTML = errorMsg;
          containerAll.innerHTML = errorMsg;
          clearStats();
        }
      }
    }

    // Refresh sheet data (force fetch from OneDrive)
    function refreshSheetData() {
      loadSheetData(true);
    }

    // Render sheet data as tables
    function renderSheetData(data, reverseOrder = false, showWorksheetStats = true) {
      let html = '';

      // Render each worksheet
      if (data.worksheets && data.worksheets.length > 0) {
        data.worksheets.forEach((worksheet, index) => {
          html += renderWorksheet(worksheet, index, reverseOrder, showWorksheetStats);
        });
      } else {
        html += '<div class="error">No worksheet data found</div>';
      }

      return html;
    }

    // Render a single worksheet with structured topics
    function renderWorksheet(worksheet, index, reverseOrder = false, showWorksheetStats = true) {
      let html = `
        <div class="worksheet">
      `;

      if (worksheet.error) {
        html += `<div class="error">Error: ${escapeHtml(worksheet.error)}</div>`;
      } else if (worksheet.topics && worksheet.topics.length > 0) {
        // Show statistics if available (only if showWorksheetStats is true)
        if (worksheet.statistics && showWorksheetStats) {
          html += renderStatistics(worksheet.statistics);
        }

        // Render each topic with its words (optionally reversed)
        let topicsToRender = worksheet.topics;
        if (reverseOrder) {
          topicsToRender = [...worksheet.topics].reverse();
        }
        topicsToRender.forEach(topic => {
          html += renderTopic(topic);
        });
      } else if (worksheet.values && worksheet.values.length > 0) {
        // Fallback for raw data (if transformer failed)
        html += renderRawTable(worksheet);
      } else {
        html += '<div class="error">No data in this worksheet</div>';
      }

      html += '</div>';
      return html;
    }

    // Render statistics box
    function renderStatistics(stats) {
      return `
        <div class="worksheet-info">
          <strong>üìà Statistics</strong> 
          üÜï New: ${stats.byFlag.new} | 
          ‚úÖ Known: ${stats.byFlag.known} | 
          ‚ùì Forgotten: ${stats.byFlag.forgotten} | 
          üëç Learned: ${stats.byFlag.learned}
        </div>
      `;
    }

    // Render a single topic with its vocabulary words
    function renderTopic(topic) {
      let html = `
        <div style="margin-bottom: 25px;">
          <div class="worksheet-info" style="background: #e3f2fd; margin-bottom: 10px;">
            <strong>üìö ${escapeHtml(topic.name)}</strong> (${topic.words.length} words)
          </div>
      `;

      // Display topic statistics if available
      if (topic.statistics) {
        html += renderStatistics(topic.statistics);
      }

      html += `
          <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Flag</th>
                <th>Word</th>
                <th>POS</th>
                <th>Pronunciation</th>
                <th>Meaning (VI)</th>
                <th>Example</th>
                <th>Synonyms</th>
                <th>Day</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
      `;

      topic.words.forEach((word, idx) => {
        const flagValue = word.flag ? word.flag.toString().toLowerCase().trim() : '';
        let bgColor = '';
        
        if (flagValue === 'n') {
          bgColor = '#fcdcdf'; // New - pastel pink
        } else if (flagValue === 'y') {
          bgColor = '#c6e0b4'; // Known - pastel green
        } else if (flagValue === 'ok') {
          bgColor = '#fff2cc'; // Learned - pastel yellow
        } else if (flagValue === '?') {
          bgColor = '#ffeb9c'; // Forgotten - pastel yellow
        }
        
        const tdStyle = bgColor ? `background-color: ${bgColor} !important;` : '';
        html += `
          <tr>
            <td style="${tdStyle}">${escapeHtml(word.order || (idx + 1))}</td>
            <td style="text-align: center;${tdStyle}">${escapeHtml(word.flag || '')}</td>
            <td style="font-weight: bold;${tdStyle}">${escapeHtml(word.word)}</td>
            <td style="${tdStyle}"><em>${escapeHtml(word.partOfSpeech)}</em></td>
            <td style="${tdStyle}">${escapeHtml(word.pronunciation)}</td>
            <td style="${tdStyle}">${escapeHtml(word.meaning)}</td>
            <td style="font-style: italic;${tdStyle}">${escapeHtml(word.exampleSentence)}</td>
            <td style="${tdStyle}">${escapeHtml(word.synonyms)}</td>
            <td style="${tdStyle}">${escapeHtml(word.dayOfWeek)}</td>
            <td style="${tdStyle}">${escapeHtml(formatDate(word.date))}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
          </div>
        </div>
      `;

      return html;
    }

    // Render raw table (fallback)
    function renderRawTable(worksheet) {
      let html = `
        <div class="worksheet-info">
          Range: ${escapeHtml(worksheet.range)} | 
          Rows: ${worksheet.rowCount} | 
          Columns: ${worksheet.columnCount}
        </div>
        <div class="table-container">
          <table>
      `;

      worksheet.values.forEach((row, rowIndex) => {
        html += '<tr>';
        row.forEach((cell, cellIndex) => {
          const tag = rowIndex === 0 ? 'th' : 'td';
          const value = cell !== null && cell !== undefined ? escapeHtml(String(cell)) : '';
          html += `<${tag}>${value}</${tag}>`;
        });
        html += '</tr>';
      });

      html += `
          </table>
        </div>
      `;

      return html;
    }

    // Render a single topic with card layout for vocabulary words
    function renderTopicAsCards(topic) {
      let html = `<div class="word-cards-container">`;

      // Sort words alphabetically for better organization
      const sortedWords = topic.words ? [...topic.words].sort((a, b) => {
        return a.word.localeCompare(b.word, 'en', { sensitivity: 'base' });
      }) : [];

      sortedWords.forEach((word, idx) => {
        const flagValue = word.flag ? word.flag.toString().toLowerCase().trim() : '';
        let flagClass = '';
        let flagText = '';
        
        if (flagValue === 'n') {
          flagClass = 'new';
          flagText = 'N';
        } else if (flagValue === 'y') {
          flagClass = 'known';
          flagText = 'Y';
        } else if (flagValue === 'ok') {
          flagClass = 'learned';
          flagText = 'OK';
        } else if (flagValue === '?') {
          flagClass = 'forgotten';
          flagText = '?';
        } else {
          flagClass = '';
          flagText = flagValue || '';
        }

        html += `
          <div class="word-card flag-${flagClass}">
            <div class="card-number">${idx + 1}</div>
            ${flagText ? `<div class="card-flag ${flagClass}">${escapeHtml(flagText)}</div>` : ''}
            <div class="word-main">
              <div class="word-english">${escapeHtml(word.word)}</div>
              ${word.pronunciation ? `<div class="word-pronunciation">${escapeHtml(word.pronunciation)}</div>` : ''}
              ${word.partOfSpeech ? `<div class="word-pos">${escapeHtml(word.partOfSpeech)}</div>` : ''}
            </div>
            ${word.meaning ? `<div class="word-meaning">${escapeHtml(word.meaning)}</div>` : ''}
            ${word.synonyms ? `
              <div class="word-synonyms">
                <div class="synonyms-label">Synonyms</div>
                <div class="synonyms-text">${escapeHtml(word.synonyms)}</div>
              </div>
            ` : ''}
            ${word.exampleSentence ? `<div class="word-example">${escapeHtml(word.exampleSentence)}</div>` : ''}
          </div>
        `;
      });

      html += `</div>`;

      return html;
    }

    // Render sheet data as cards for newest topic filter
    function renderSheetDataAsCards(data) {
      let html = '';

      // Render each worksheet
      if (data.worksheets && data.worksheets.length > 0) {
        data.worksheets.forEach((worksheet, index) => {
          html += renderWorksheetAsCards(worksheet, index);
        });
      } else {
        html += '<div class="error">No worksheet data found</div>';
      }

      return html;
    }

    // Render a single worksheet with card layout
    function renderWorksheetAsCards(worksheet, index) {
      let html = '';

      if (worksheet.error) {
        html += `<div class="error">Error: ${escapeHtml(worksheet.error)}</div>`;
      } else if (worksheet.topics && worksheet.topics.length > 0) {
        // Render each topic as cards
        worksheet.topics.forEach(topic => {
          html += renderTopicAsCards(topic);
        });
      } else {
        html += '<div class="error">No data in this worksheet</div>';
      }

      return html;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateValue) {
      if (!dateValue) return '';
      
      let date;
      
      // Handle Excel serial date numbers (Excel epoch is 1/1/1900)
      if (typeof dateValue === 'number') {
        const excelEpoch = new Date(1900, 0, 1);
        date = new Date(excelEpoch.getTime() + (dateValue - 1) * 86400000);
      } else if (typeof dateValue === 'string') {
        // Remove any extra whitespace
        const trimmed = dateValue.trim();
        
        // Try to parse as ISO or standard date format
        date = new Date(trimmed);
        
        // If parsing failed, try other formats
        if (isNaN(date.getTime())) {
          // Try to parse common formats like "2/9/2024" or "02/09/2024"
          const parts = trimmed.split(/[-\/]/);
          if (parts.length === 3) {
            const month = parseInt(parts[0]) - 1; // months are 0-indexed
            const day = parseInt(parts[1]);
            const year = parseInt(parts[2]);
            date = new Date(year, month, day);
          }
        }
      } else {
        date = new Date(dateValue);
      }
      
      // Check if date is valid
      if (isNaN(date.getTime())) {
        return dateValue; // Return original value if can't parse
      }
      
      // Format as m/d/yyyy
      const month = date.getMonth() + 1; // getMonth() returns 0-11
      const day = date.getDate();
      const year = date.getFullYear();
      
      return `${month}/${day}/${year}`;
    }

    // Calculate total statistics across all worksheets
    function calculateTotalStats(data) {
      let totalStats = {
        new: 0,
        known: 0,
        forgotten: 0,
        learned: 0,
        totalTopics: 0
      };

      if (data.worksheets && Array.isArray(data.worksheets)) {
        data.worksheets.forEach(worksheet => {
          if (worksheet.statistics && worksheet.statistics.byFlag) {
            totalStats.new += worksheet.statistics.byFlag.new || 0;
            totalStats.known += worksheet.statistics.byFlag.known || 0;
            totalStats.forgotten += worksheet.statistics.byFlag.forgotten || 0;
            totalStats.learned += worksheet.statistics.byFlag.learned || 0;
          }
          
          // Count total topics
          if (worksheet.topics && Array.isArray(worksheet.topics)) {
            totalStats.totalTopics += worksheet.topics.length;
          }
        });
      }

      return totalStats;
    }

    // Display vocabulary statistics
    function displayStats(stats) {
      console.log('üìä Displaying stats:', stats);
      const statsSummary = document.getElementById('statsSummary');
      if (statsSummary) {
        document.getElementById('statNew').textContent = stats.new || 0;
        document.getElementById('statForgotten').textContent = stats.forgotten || 0;
        document.getElementById('statLearned').textContent = stats.learned || 0;
        document.getElementById('statKnown').textContent = stats.known || 0;
        
        // Calculate and display total words
        const totalWords = (stats.new || 0) + (stats.known || 0) + (stats.forgotten || 0) + (stats.learned || 0);
        document.getElementById('statTotal').textContent = totalWords;
        
        // Display total topics
        document.getElementById('statTopics').textContent = stats.totalTopics || 0;
        
        // Always show the statistics container
        statsSummary.style.display = 'grid';
        console.log('‚úÖ Statistics displayed and container shown');
      } else {
        console.error('‚ùå statsSummary element not found');
      }
    }

    // Clear statistics display
    function clearStats() {
      const statsSummary = document.getElementById('statsSummary');
      if (statsSummary) {
        statsSummary.style.display = 'none';
      }
    }

    // Initialize page - display cached data immediately if available
    function initPage() {
      console.log('Initializing page...');
      
      // Show statistics container immediately
      const statsSummary = document.getElementById('statsSummary');
      if (statsSummary) {
        statsSummary.style.display = 'grid';
      }
      
      // Check if we have embedded cached data and display it immediately
      if (window.CACHED_DATA) {
        console.log('Displaying embedded cached data immediately');
        displayDataInstantly(window.CACHED_DATA, window.CACHE_TIMESTAMP);
      } else {
        console.log('No embedded data, loading from API cache immediately');
        // Load from API cache immediately without showing loading
        loadSheetDataSilent();
      }
      
      // Load sheet URL and name in background (async)
      setTimeout(() => {
        loadSheetUrl();
      }, 0);
    }

    // Display data instantly without any loading states
    function displayDataInstantly(data, timestamp) {
      console.log('üöÄ Displaying data instantly...', data);
      
      // Display statistics immediately
      const totalStats = calculateTotalStats(data);
      console.log('üìä Calculated stats:', totalStats);
      displayStats(totalStats);
      
      // Store data globally
      currentData = data;
      
      // Display cache info
      if (timestamp) {
        const cachedTime = new Date(timestamp).toLocaleString('vi-VN', {
          hour: '2-digit',
          minute: '2-digit', 
          second: '2-digit',
          day: 'numeric',
          month: 'numeric',
          year: 'numeric'
        });
        const cacheInfoDiv = document.getElementById('cacheInfo');
        if (cacheInfoDiv) {
          cacheInfoDiv.innerHTML = `<div class="cache-info">üì¶ Cached: ${cachedTime}</div>`;
        }
      }
      
      // Render data immediately
      const containerAll = document.getElementById('dataContainerAllVocab');
      if (containerAll) {
        const renderedData = renderSheetData(data, false, false);
        console.log('üìù Rendered HTML length:', renderedData.length);
        containerAll.innerHTML = renderedData;
      }
      
      console.log('‚úÖ Data display completed instantly');
    }

    // Load data silently without showing any loading states
    function loadSheetDataSilent() {
      fetch('/api/sheet/data')
        .then(response => response.json())
        .then(data => {
          if (!data.error) {
            console.log('Loaded cached data from API silently');
            displayDataInstantly(data, data._cachedAt || data._fetchedAt);
          }
        })
        .catch(err => {
          console.error('Failed to load cached data silently:', err);
        });
    }

    // Start initialization immediately (synchronously)
    initPage();
  </script>
</body>
</html>
